# Day 016: Install and Configure Nginx as a Load Balancer

**Time**: 20 minutes

## Objective
Day by day traffic is increasing on one of the websites managed by the `Nautilus` production support team. 

Therefore, the team has observed a degradation in website performance. Following discussions about this issue, the team has decided to deploy this application on a high availability stack i.e on `Nautilus` infra in `Stratos DC`. 

They started the migration last month and it is almost done, as only the LBR server configuration is pending. Configure LBR server as per the information given below:

- Install `nginx` on `LBR` (load balancer) server.
- Configure load-balancing with the an `http` context making use of all `App Servers`. Ensure that you update only the main Nginx configuration file located at `/etc/nginx/nginx.conf`.
- Make sure you do not update the apache port that is already defined in the apache configuration on all app servers, also make sure apache service is up and running on all app servers.


d. Once done, you can access the website using `StaticApp` button on the top bar.

## Technologies Used
- `curl`
- `systemctl`
- `ss`
- `yum`
- `nginx`

## Steps

1. SSH into `stapp01` server, determine which port HTTPD is running on

    ```bash
    # SSH to stapp01
    thor@jumphost ~$ ssh tony@stapp01
    [tony@stapp01 ~]$ sudo ss -tulpn | grep httpd
    # tcp   LISTEN 0      511          0.0.0.0:6100       0.0.0.0:*    users:(("httpd",pid=1692,fd=3),("httpd",pid=1691,fd=3),("httpd",pid=1690,fd=3),("httpd",pid=1682,fd=3))

    # HTTPd is running on 6100
    ```

2. Install and configure `nginx` on Load Balancer

    ```bash
    # In a different terminal, connect to load balancer
    thor@jumphost ~$ ssh loki@stlb01
    [loki@stlb01 ~]$

    # Install NGINX, start it
    [loki@stlb01 ~]$ sudo yum install nginx -y
    [loki@stlb01 ~]$ sudo systemctl enable nginx
    [loki@stlb01 ~]$ sudo systemctl start nginx

    # According to NGINX documentation:
    # https://nginx.org/en/docs/http/load_balancing.html
    
    # We need to modify /etc/nginx/nginx.conf and add this inside http section just before server:80
    # upstream stapp {
    #         server stapp01:6100;
    #         server stapp02:6100;
    #         server stapp03:6100;
    #     }
    [loki@stlb01 ~]$ sudo vi /etc/nginx/nginx.conf

    # Make edits above, save and exit
    ```

3. Test NGINX config

    ```bash
    # test config, restart
    [loki@stlb01 ~]$ sudo nginx -t
    [loki@stlb01 ~]$ sudo systemctl restart nginx
     
    # Click button to connect to the Statis Web App in the upper right of the screen. Verify NGINX was configured correctly.
    ```

## Key Takeaways
- Always review developer docs for instructions on configuration file instructions.
