# Day 053: Resolve VolumeMounts Issue in Kubernetes

**Time**: 20 minutes

## Objective
We encountered an issue with our Nginx and PHP-FPM setup on the Kubernetes cluster this morning, which halted its functionality. Investigate and rectify the issue:

The pod name is `nginx-phpfpm` and configmap name is `nginx-config`. Identify and fix the problem.

Once resolved, copy `/home/thor/index.php` file from the jump host to the `nginx-container` within the nginx document root. After this, you should be able to access the website using `Website` button on the top bar.
## Technologies Used
- `kubectl`
- `vi`

## Steps

1. Verify the pod is running.

    ```bash
    thor@jumphost ~$ k get pods 
    NAME           READY   STATUS    RESTARTS   AGE
    nginx-phpfpm   2/2     Running   0          95s
    ```

2. Describe the pod to review container mounts.

    ```bash
    thor@jumphost ~$ k describe pods nginx-phpfpm 
    Name:             nginx-phpfpm
    Namespace:        default
    Priority:         0
    Service Account:  default
    Node:             kodekloud-control-plane/172.17.0.2
    Start Time:       Wed, 14 Jan 2026 12:52:27 +0000
    Labels:           app=php-app
    Annotations:      <none>
    Status:           Running
    IP:               10.244.0.5
    IPs:
      IP:  10.244.0.5
    Containers:
      php-fpm-container:
        Container ID:   containerd://13db8fa4a462492493a86c5f5258c866444805d8db667f722419ea86ed4ea8e8
        Image:          php:7.2-fpm-alpine
        Image ID:       docker.io/library/php@sha256:2e2d92415f3fc552e9a62548d1235f852c864fcdc94bcf2905805d92baefc87f
        Port:           <none>
        Host Port:      <none>
        State:          Running
          Started:      Wed, 14 Jan 2026 12:52:30 +0000
        Ready:          True
        Restart Count:  0
        Environment:    <none>
        Mounts:
          /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-fq7fd (ro)
          /var/www/html from shared-files (rw)
      nginx-container:
        Container ID:   containerd://022e71c5a655a654c573696c3177624e0f5c763090a8b7b4821226a7c6677c0e
        Image:          nginx:latest
        Image ID:       docker.io/library/nginx@sha256:c881927c4077710ac4b1da63b83aa163937fb47457950c267d92f7e4dedf4aec
        Port:           <none>
        Host Port:      <none>
        State:          Running
          Started:      Wed, 14 Jan 2026 12:52:37 +0000
        Ready:          True
        Restart Count:  0
        Environment:    <none>
        Mounts:
          /etc/nginx/nginx.conf from nginx-config-volume (rw,path="nginx.conf")
          /usr/share/nginx/html from shared-files (rw)
          /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-fq7fd (ro)
    Conditions:
      Type              Status
      Initialized       True 
      Ready             True 
      ContainersReady   True 
      PodScheduled      True 
    Volumes:
      shared-files:
        Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
        Medium:     
        SizeLimit:  <unset>
      nginx-config-volume:
        Type:      ConfigMap (a volume populated by a ConfigMap)
        Name:      nginx-config
        Optional:  false
      kube-api-access-fq7fd:
        Type:                    Projected (a volume that contains injected data from multiple sources)
        TokenExpirationSeconds:  3607
        ConfigMapName:           kube-root-ca.crt
        ConfigMapOptional:       <nil>
        DownwardAPI:             true
    QoS Class:                   BestEffort
    Node-Selectors:              <none>
    Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
    Events:
      Type    Reason     Age   From               Message
      ----    ------     ----  ----               -------
      Normal  Scheduled  109s  default-scheduler  Successfully assigned default/nginx-phpfpm to kodekloud-control-plane
      Normal  Pulling    109s  kubelet            Pulling image "php:7.2-fpm-alpine"
      Normal  Pulled     106s  kubelet            Successfully pulled image "php:7.2-fpm-alpine" in 2.797155105s (2.797173723s including waiting)
      Normal  Created    106s  kubelet            Created container php-fpm-container
      Normal  Started    106s  kubelet            Started container php-fpm-container
      Normal  Pulling    106s  kubelet            Pulling image "nginx:latest"
      Normal  Pulled     100s  kubelet            Successfully pulled image "nginx:latest" in 5.842296067s (5.842314013s including waiting)
      Normal  Created    100s  kubelet            Created container nginx-container
      Normal  Started    99s   kubelet            Started container nginx-container
    ```

3. Check PHP-FPM logs to confirm it is healthy.

    ```bash
    thor@jumphost ~$ k logs pods/nginx-phpfpm 
    Defaulted container "php-fpm-container" out of: php-fpm-container, nginx-container
    [14-Jan-2026 12:52:30] NOTICE: fpm is running, pid 1
    [14-Jan-2026 12:52:30] NOTICE: ready to handle connections
    ```

4. Exec into the nginx container and confirm the document root used by Nginx.

    ```bash
    thor@jumphost ~$ kubectl exec --stdin --tty nginx-phpfpm --container=nginx-container -- /bin/bash
    root@nginx-phpfpm:/# ls -la /usr/share/nginx/
    total 16
    drwxr-xr-x 3 root root 4096 Jan 13 01:22 .
    drwxr-xr-x 1 root root 4096 Jan 13 01:22 ..
    drwxrwxrwx 2 root root 4096 Jan 14 12:52 html
    root@nginx-phpfpm:/# ls -la /usr/share/nginx/html/
    total 8
    drwxrwxrwx 2 root root 4096 Jan 14 12:52 .
    drwxr-xr-x 3 root root 4096 Jan 13 01:22 ..
    root@nginx-phpfpm:/# ls -la /etc/nginx/
    conf.d/         fastcgi_params  mime.types      modules/        nginx.conf      scgi_params     uwsgi_params
    root@nginx-phpfpm:/# cat /etc/nginx/nginx.conf 
    events {
    }
    http {
      server {
        listen 8099 default_server;
        listen [::]:8099 default_server;

        # Set nginx to serve files from the shared volume!
        root /var/www/html;
        index  index.html index.htm index.php;
        server_name _;
        location / {
          try_files $uri $uri/ =404;
        }
        location ~ \.php$ {
          include fastcgi_params;
          fastcgi_param REQUEST_METHOD $request_method;
          fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
          fastcgi_pass 127.0.0.1:9000;
        }
      }
    }
    root@nginx-phpfpm:/# exit 
    exit
    ```

5. Export the pod manifest to confirm the volume mount path on nginx.

    ```bash
    thor@jumphost ~$ kubectl get pods  nginx-phpfpm -o yaml > pod.yaml
    thor@jumphost ~$ cat pod.yaml 
    apiVersion: v1
    kind: Pod
    metadata:
      annotations:
        kubectl.kubernetes.io/last-applied-configuration: |
          {"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{},"labels":{"app":"php-app"},"name":"nginx-phpfpm","namespace":"default"},"spec":{"containers":[{"image":"php:7.2-fpm-alpine","name":"php-fpm-container","volumeMounts":[{"mountPath":"/var/www/html","name":"shared-files"}]},{"image":"nginx:latest","name":"nginx-container","volumeMounts":[{"mountPath":"/usr/share/nginx/html","name":"shared-files"},{"mountPath":"/etc/nginx/nginx.conf","name":"nginx-config-volume","subPath":"nginx.conf"}]}],"volumes":[{"emptyDir":{},"name":"shared-files"},{"configMap":{"name":"nginx-config"},"name":"nginx-config-volume"}]}}
      creationTimestamp: "2026-01-14T12:52:27Z"
      labels:
        app: php-app
      name: nginx-phpfpm
      namespace: default
      resourceVersion: "1970"
      uid: 49f931d4-cce9-44f6-a834-8f929a361eb7
    spec:
      containers:
      - image: php:7.2-fpm-alpine
        imagePullPolicy: IfNotPresent
        name: php-fpm-container
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /var/www/html
          name: shared-files
        - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
          name: kube-api-access-fq7fd
          readOnly: true
      - image: nginx:latest
        imagePullPolicy: Always
        name: nginx-container
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /usr/share/nginx/html
          name: shared-files
        - mountPath: /etc/nginx/nginx.conf
          name: nginx-config-volume
          subPath: nginx.conf
        - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
          name: kube-api-access-fq7fd
          readOnly: true
      dnsPolicy: ClusterFirst
      enableServiceLinks: true
      nodeName: kodekloud-control-plane
      preemptionPolicy: PreemptLowerPriority
      priority: 0
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: default
      serviceAccountName: default
      terminationGracePeriodSeconds: 30
      tolerations:
      - effect: NoExecute
        key: node.kubernetes.io/not-ready
        operator: Exists
        tolerationSeconds: 300
      - effect: NoExecute
        key: node.kubernetes.io/unreachable
        operator: Exists
        tolerationSeconds: 300
      volumes:
      - emptyDir: {}
        name: shared-files
      - configMap:
          defaultMode: 420
          name: nginx-config
        name: nginx-config-volume
      - name: kube-api-access-fq7fd
        projected:
          defaultMode: 420
          sources:
          - serviceAccountToken:
              expirationSeconds: 3607
              path: token
          - configMap:
              items:
              - key: ca.crt
                path: ca.crt
              name: kube-root-ca.crt
          - downwardAPI:
              items:
              - fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
                path: namespace
    status:
      conditions:
      - lastProbeTime: null
        lastTransitionTime: "2026-01-14T12:52:27Z"
        status: "True"
        type: Initialized
      - lastProbeTime: null
        lastTransitionTime: "2026-01-14T12:52:37Z"
        status: "True"
        type: Ready
      - lastProbeTime: null
        lastTransitionTime: "2026-01-14T12:52:37Z"
        status: "True"
        type: ContainersReady
      - lastProbeTime: null
        lastTransitionTime: "2026-01-14T12:52:27Z"
        status: "True"
        type: PodScheduled
      containerStatuses:
      - containerID: containerd://022e71c5a655a654c573696c3177624e0f5c763090a8b7b4821226a7c6677c0e
        image: docker.io/library/nginx:latest
        imageID: docker.io/library/nginx@sha256:c881927c4077710ac4b1da63b83aa163937fb47457950c267d92f7e4dedf4aec
        lastState: {}
        name: nginx-container
        ready: true
        restartCount: 0
        started: true
        state:
          running:
            startedAt: "2026-01-14T12:52:37Z"
      - containerID: containerd://13db8fa4a462492493a86c5f5258c866444805d8db667f722419ea86ed4ea8e8
        image: docker.io/library/php:7.2-fpm-alpine
        imageID: docker.io/library/php@sha256:2e2d92415f3fc552e9a62548d1235f852c864fcdc94bcf2905805d92baefc87f
        lastState: {}
        name: php-fpm-container
        ready: true
        restartCount: 0
        started: true
        state:
          running:
            startedAt: "2026-01-14T12:52:30Z"
      hostIP: 172.17.0.2
      phase: Running
      podIP: 10.244.0.5
      podIPs:
      - ip: 10.244.0.5
      qosClass: BestEffort
      startTime: "2026-01-14T12:52:27Z"
    ```

6. Confirm the nginx configmap root path for comparison.

    ```bash
    thor@jumphost ~$ k get cm nginx-config -o yaml
    apiVersion: v1
    data:
      nginx.conf: |
        events {
        }
        http {
          server {
            listen 8099 default_server;
            listen [::]:8099 default_server;

            # Set nginx to serve files from the shared volume!
            root /var/www/html;
            index  index.html index.htm index.php;
            server_name _;
            location / {
              try_files $uri $uri/ =404;
            }
            location ~ \.php$ {
              include fastcgi_params;
              fastcgi_param REQUEST_METHOD $request_method;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_pass 127.0.0.1:9000;
            }
          }
        }
    kind: ConfigMap
    metadata:
      annotations:
        kubectl.kubernetes.io/last-applied-configuration: |
          {"apiVersion":"v1","data":{"nginx.conf":"events {\n}\nhttp {\n  server {\n    listen 8099 default_server;\n    listen [::]:8099 default_server;\n\n    # Set nginx to serve files from the shared volume!\n    root /var/www/html;\n    index  index.html index.htm index.php;\n    server_name _;\n    location / {\n      try_files $uri $uri/ =404;\n    }\n    location ~ \\.php$ {\n      include fastcgi_params;\n      fastcgi_param REQUEST_METHOD $request_method;\n      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n      fastcgi_pass 127.0.0.1:9000;\n    }\n  }\n}\n"},"kind":"ConfigMap","metadata":{"annotations":{},"name":"nginx-config","namespace":"default"}}
      creationTimestamp: "2026-01-14T12:52:27Z"
      name: nginx-config
      namespace: default
      resourceVersion: "1939"
      uid: a45b5de4-1ffc-4d96-9d34-b5e66f862f14
    ```

## Key Takeaways
- Nginx can serve a different path than the volume mount, so check `nginx.conf` when files are missing
- For shared volumes, mountPath must match the web root used by the container
