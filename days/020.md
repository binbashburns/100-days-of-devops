
# Day 020: Configure Nginx + PHP-FPM Using Unix Socket

**Time**: 45 minutes

## Objective
The `Nautilus` application development team is planning to launch a new PHP-based application, which they want to deploy on `Nautilus` infra in `Stratos DC`. 

The development team had a meeting with the production support team and they have shared some requirements regarding the infrastructure. Below are the requirements they shared:
- Install `nginx` on `app server 3`, configure it to use port `8092` and its document root should be `/var/www/html`.
- Install `php-fpm` version `8.3` on `app server 3`, it must use the unix socket `/var/run/php-fpm/default.sock` (create the parent directories if they do not exist).
- Configure `php-fpm` and nginx to work together.
- Once configured correctly, you can test the website using `curl http://stapp03:8092/index.php` command from `jump host`.

**NOTE**: `index.php` and `info.php` are copied under `/var/www/html` on the correct app server. If you do not see them there, you are likely on the wrong app server.

## Technologies Used
- CentOS Stream 9
- Nginx
- PHP 8.3 (php-fpm)
- Remi + EPEL repositories
- systemd
- curl

## Steps

1. SSH into `App Server 3` and verify application files

    ```bash
    # SSH to stapp03 (App Server 3)
    thor@jumphost ~$ ssh banner@stapp03
    [banner@stapp03 ~]$

    # Confirm the PHP app files exist
    [banner@stapp03 ~]$ ls -l /var/www/html
    # Expect to see at least: index.php and info.php
    ```

    If `ls` shows `No such file or directory` or the files are missing, you are on the wrong app server.

2. Install `nginx` and `php-fpm` 8.3

    ```bash
    # Pull dnf updates, install nginx, and enable Remi PHP 8.3
    [banner@stapp03 ~]$ sudo dnf update -y
    [banner@stapp03 ~]$ sudo dnf install -y nginx
    [banner@stapp03 ~]$ sudo dnf install -y https://rpms.remirepo.net/enterprise/remi-release-9.rpm

    # Reset any existing php module, then enable remi-8.3
    [banner@stapp03 ~]$ sudo dnf module reset -y php
    [banner@stapp03 ~]$ sudo dnf module enable -y php:remi-8.3

    # Install php-fpm 8.3 and common extensions
    [banner@stapp03 ~]$ sudo dnf install -y php-fpm php php-cli php-common php-mysqlnd php-gd php-xml php-mbstring php-pdo php-opcache

    # Check: confirm php-fpm is 8.3.x
    [banner@stapp03 ~]$ php-fpm -v
    # Expect: PHP 8.3.x (fpm-fcgi)
    ```

3. Configure `php-fpm`

    ```bash
    [banner@stapp03 ~]$ sudo mkdir -p /var/run/php-fpm
    [banner@stapp03 ~]$ sudo vi /etc/php-fpm.d/www.conf
    ```

    In `/etc/php-fpm.d/www.conf` update these lines (uncomment if needed):

    ```ini
    user = nginx
    group = nginx

    listen = /var/run/php-fpm/default.sock

    listen.owner = nginx
    listen.group = nginx
    listen.mode  = 0660
    ```

    Then ensure the socket directory has the right owner:

    ```bash
    [banner@stapp03 ~]$ sudo chown -R nginx:nginx /var/run/php-fpm
    ```

    Optional checks:

    ```bash
    [banner@stapp03 ~]$ grep -E '^(user|group|listen|listen.owner|listen.group|listen.mode)' /etc/php-fpm.d/www.conf
    [banner@stapp03 ~]$ ls -ld /var/run/php-fpm
    ```

4. Configure `nginx`

    ```bash
    [banner@stapp03 ~]$ sudo vi /etc/nginx/nginx.conf
    ```

    Inside the main `server { ... }` block under `http { ... }`, change the defaults to match the lab:

    ```nginx
    # Change this:
    #   listen       80;
    #   root         /usr/share/nginx/html;

    # To this:
    listen       8092;
    listen       [::]:8092;
    server_name  _;
    root         /var/www/html;
    index        index.php index.html index.htm;

    # Load configuration files for the default server block.
    include /etc/nginx/default.d/*.conf;
    ```

    Make sure `/etc/nginx/nginx.conf` keeps this include inside the `http { ... }` block so your server config is loaded:

    ```nginx
    include /etc/nginx/conf.d/*.conf;
    ```

5. Configure `php` with `nginx`

    ```bash
    [banner@stapp03 ~]$ sudo vi /etc/nginx/default.d/php.conf
    ```

    Replace the existing PHP location block so it looks like this:

    ```nginx
    # pass the PHP scripts to FastCGI server
    #
    # See conf.d/php-fpm.conf for socket configuration
    #
    index index.php index.html index.htm;

    location ~ \.php$ {
        root           /var/www/html;
        fastcgi_pass   unix:/var/run/php-fpm/default.sock;
        fastcgi_index  index.php;
        include        fastcgi_params;
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
    ```

    This makes sure Nginx passes `/var/www/html/index.php` and `/var/www/html/info.php` to the PHP-FPM socket.

6. Restart `nginx` and `php-fpm` and run checks

    ```bash
    [banner@stapp03 ~]$ sudo systemctl enable --now php-fpm
    [banner@stapp03 ~]$ sudo systemctl enable --now nginx
    [banner@stapp03 ~]$ sudo systemctl restart php-fpm nginx

    # Service status checks
    [banner@stapp03 ~]$ systemctl status php-fpm --no-pager
    [banner@stapp03 ~]$ systemctl status nginx --no-pager

    # Check that the PHP-FPM socket file exists
    [banner@stapp03 ~]$ ls -l /var/run/php-fpm/default.sock
    ```

7. Open a new terminal and test from jump host

    ```bash
    thor@jumphost ~$ curl http://stapp03:8092/index.php
    thor@jumphost ~$ curl http://stapp03:8092/info.php
    ```

    - `index.php` should return the app page, not the default nginx 404 HTML.
    - `info.php` should return the PHP info page, showing `PHP Version 8.3.x` near the top.

## Quick Troubleshooting Notes

- If `curl` returns `File not found.` for `index.php` or `info.php`:
  - Confirm you are on the correct app server (`stapp03`) and not `stapp01` or `stapp02`.
  - Run `ls -l /var/www/html` on `stapp03` and verify `index.php` and `info.php` exist.
  - Confirm `SCRIPT_FILENAME` is set to `$document_root$fastcgi_script_name` in `/etc/nginx/default.d/php.conf`.

- If `curl` returns the default nginx 404 page:
  - Check the `root` and `index` directives in `nginx.conf` under the `server` block.
  - Make sure Nginx is listening on port `8092` and you are curling the same port from the jump host.
