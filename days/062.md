# Day 062: Manage Secrets in Kubernetes

**Time**: 15 minutes

## Objective
The Nautilus DevOps team is working to deploy some tools in Kubernetes cluster. Some of the tools are licence based so that license information needs to be stored securely within Kubernetes cluster. Therefore, the team wants to utilize Kubernetes secrets to store those secrets. Below you can find more details about the requirements:

We already have a secret key file `ecommerce.txt` under `/opt` location on `jump host`. Create a `generic secret` named `ecommerce`, it should contain the password/license-number present in `ecommerce.txt` file.

Also create a `pod` named `secret-datacenter`.

Configure pod's `spec` as container name should be `secret-container-datacenter`, image should be `debian` with `latest` tag (remember to mention the tag with image). Use `sleep` command for container so that it remains in running state. Consume the created secret and mount it under `/opt/cluster` within the container.

To verify you can exec into the container `secret-container-datacenter`, to check the secret key under the mounted path `/opt/cluster`. Before hitting the `Check` button please make sure pod/pods are in running state, also validation can take some time to complete so keep patience.

## Technologies Used
- `kubectl`
- `vi`

## Steps

1. Verify the secret key file exists on the jump host

    ```bash
    thor@jumphost ~$ ls -la /opt/
    total 12
    drwxr-xr-x 1 thor thor 4096 Feb  6 14:11 .
    drwxr-xr-x 1 root root 4096 Feb  6 14:11 ..
    -rw-r--r-- 1 root root    7 Feb  6 14:11 ecommerce.txt
    ```

2. Generate the secret manifest using `--dry-run` and redirect to a file

    ```bash
    thor@jumphost ~$ kubectl create secret generic ecommerce --from-file=/opt/ecommerce.txt -o yaml --dry-run=client > mani.yaml
    ```

3. Edit the manifest to add the pod definition. Reference [062-all-resources.yaml](../configs/062-all-resources.yaml)

    ```bash
    thor@jumphost ~$ vi mani.yaml
    ```

4. Apply the manifest to create both the secret and the pod

    ```bash
    thor@jumphost ~$ k apply -f mani.yaml 
    secret/ecommerce created
    pod/secret-datacenter created
    ```

5. Verify the pod is running

    ```bash
    thor@jumphost ~$ k get pods
    NAME                READY   STATUS    RESTARTS   AGE
    secret-datacenter   1/1     Running   0          10s
    ```

6. Exec into the container and verify the secret is mounted correctly

    ```bash
    thor@jumphost ~$ k exec --stdin --tty secret-datacenter -- /bin/bash
    root@secret-datacenter:/# ls -la /opt/cluster/
    total 4
    drwxrwxrwt 3 root root  100 Feb  6 14:28 .
    drwxr-xr-x 1 root root 4096 Feb  6 14:28 ..
    drwxr-xr-x 2 root root   60 Feb  6 14:28 ..2026_02_06_14_28_12.3130109006
    lrwxrwxrwx 1 root root   32 Feb  6 14:28 ..data -> ..2026_02_06_14_28_12.3130109006
    lrwxrwxrwx 1 root root   20 Feb  6 14:28 ecommerce.txt -> ..data/ecommerce.txt
    ```

## Key Takeaways
- Use `kubectl create secret generic --from-file --dry-run=client -o yaml` to generate secret manifests from existing files
- Secrets are mounted as symlinks within the container, pointing to versioned data directories
- The `sleep` command is useful for keeping a container running when you need to exec into it for debugging or verification

## References
- [Get a Shell to a Running Container](https://kubernetes.io/docs/tasks/debug/debug-application/get-shell-running-container/)
- [Pods](https://kubernetes.io/docs/concepts/workloads/pods/)
- [Secrets](https://kubernetes.io/docs/concepts/configuration/secret/)
