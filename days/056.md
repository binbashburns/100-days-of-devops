# Day 056: Deploy Nginx Web Server on Kubernetes Cluster

**Time**: 18 minutes

## Objective
Some of the Nautilus team developers are developing a static website and they want to deploy it on Kubernetes cluster. They want it to be highly available and scalable. Therefore, based on the requirements, the DevOps team has decided to create a deployment for it with multiple replicas. Below you can find more details about it:

Create a deployment using `nginx` image with `latest` tag only and remember to mention the tag i.e `nginx:latest`. Name it as `nginx-deployment`. The container should be named as `nginx-container`, also make sure replica counts are `3`.

Create a `NodePort` type service named `nginx-service`. The nodePort should be `30011`.

## Technologies Used
- `kubectl`
- `vi`

## Steps

1. Generate deployment manifest and modify container name

    ```bash
    # Generate the deployment manifest (note: container name defaults to "nginx", not "nginx-container")
    thor@jumphost ~$ k create deployment nginx-deployment --image=nginx:latest --replicas=3 -o yaml --dry-run=client > deploy.yaml
    
    # Edit the file to change container name from "nginx" to "nginx-container"
    thor@jumphost ~$ vi deploy.yaml
    
    # Verify the changes
    thor@jumphost ~$ cat deploy.yaml
    # apiVersion: apps/v1
    # kind: Deployment
    # metadata:
    #   creationTimestamp: null
    #   labels:
    #     app: nginx-deployment
    #   name: nginx-deployment
    # spec:
    #   replicas: 3
    #   selector:
    #     matchLabels:
    #       app: nginx-deployment
    #   strategy: {}
    #   template:
    #     metadata:
    #       creationTimestamp: null
    #       labels:
    #         app: nginx-deployment
    #     spec:
    #       containers:
    #       - image: nginx:latest
    #         ports:
    #         - containerPort: 80
    #         name: nginx-container
    #         resources: {}
    # status: {}
    ```

2. Generate NodePort service manifest (see full deployment manifest [here](../configs/056-deployment.yaml), service manifest [here](../configs/056-svc.yaml))

    ```bash
    # Generate service manifest (requires --tcp flag)
    thor@jumphost ~$ k create svc nodeport nginx-service --node-port=30011 --tcp=80:80 -o yaml --dry-run=client > svc.yaml
    ```

3. Apply the manifests

    ```bash
    thor@jumphost ~$ k apply -f deploy.yaml
    # deployment.apps/nginx-deployment created
    
    thor@jumphost ~$ k apply -f svc.yaml
    # service/nginx-service created
    ```

4. Verify deployment and service

    ```bash
    thor@jumphost ~$ k get pods
    # NAME                                READY   STATUS    RESTARTS   AGE
    # nginx-deployment-7d696b44d5-82g8f   1/1     Running   0          11s
    # nginx-deployment-7d696b44d5-rjmn9   1/1     Running   0          11s
    # nginx-deployment-7d696b44d5-wqbzd   1/1     Running   0          11s
    
    thor@jumphost ~$ k get svc
    # NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
    # kubernetes      ClusterIP   10.96.0.1       <none>        443/TCP        29m
    # nginx-service   NodePort    10.96.140.234   <none>        80:30011/TCP   6s
    ```

5. Test the service and fix selector mismatch issue

    ```bash
    thor@jumphost ~$ curl localhost:30011
    # curl: (7) Failed to connect to localhost port 30011: Connection refused
    
    # Debug: check the service selector vs pod labels
    thor@jumphost ~$ cat svc.yaml | grep -A 2 selector
    #   selector:
    #     app: nginx
    
    thor@jumphost ~$ k get pods --show-labels
    # NAME                                READY   STATUS    RESTARTS   AGE   LABELS
    # nginx-deployment-7d696b44d5-82g8f   1/1     Running   0          2m    app=nginx-deployment,pod-template-hash=7d696b44d5
    # nginx-deployment-7d696b44d5-rjmn9   1/1     Running   0          2m    app=nginx-deployment,pod-template-hash=7d696b44d5
    # nginx-deployment-7d696b44d5-wqbzd   1/1     Running   0          2m    app=nginx-deployment,pod-template-hash=7d696b44d5
    
    # The issue: service selector is "app: nginx" but pods have label "app: nginx-deployment"
    # Fix: edit svc.yaml to change selector from "nginx" to "nginx-deployment"
    thor@jumphost ~$ vi svc.yaml
    
    thor@jumphost ~$ cat svc.yaml
    # apiVersion: v1
    # kind: Service
    # metadata:
    #   name: nginx-service
    # spec:
    #   selector:
    #     app: nginx-deployment  # Changed from "nginx" to "nginx-deployment"
    #   ports:
    #   - nodePort: 30011
    #     port: 80
    #     targetPort: 80
    #   type: NodePort
    
    thor@jumphost ~$ k apply -f svc.yaml
    # service/nginx-service configured
    
    ```

## Key Takeaways
- `kubectl create deployment` doesn't have a flag to set the container name - you must edit the generated YAML
- `kubectl create service nodeport` requires the `--tcp` flag to specify port mappings
