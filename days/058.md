# Day 058: Deploy Grafana on Kubernetes Cluster

**Time**: 15 minutes

## Objective
The Nautilus DevOps teams is planning to set up a Grafana tool to collect and analyze analytics from some applications. They are planning to deploy it on Kubernetes cluster. Below you can find more details.

Create a `deployment` named `grafana-deployment-devops` using any `grafana` image for Grafana app. Set other parameters as per your choice.

Create `NodePort` type service with `nodePort` `32000` to expose the app.

You need not to make any configuration changes inside the Grafana app once deployed, just make sure you are able to access the Grafana login page.

## Technologies Used
- `kubectl`
- `vi`
- `cat`

## Steps

1. Create deployment with specs outlined in task ([file](../configs/058-deployment.yaml)), then apply it

    ```bash
    # dry run to generate manifest
    thor@jumphost ~$ kubectl create deployment grafana-deployment-devops \
    --image=grafana/grafana:latest \
    --port=3000 \
    --dry-run=client -o yaml > deploy.yaml

    # cat it out to view config
    thor@jumphost ~$ cat deploy.yaml 
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      creationTimestamp: null
      labels:
        app: grafana-deployment-devops
      name: grafana-deployment-devops
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: grafana-deployment-devops
      strategy: {}
      template:
        metadata:
          creationTimestamp: null
          labels:
            app: grafana-deployment-devops
        spec:
          containers:
          - image: grafana/grafana:latest
            name: grafana
            ports:
            - containerPort: 3000
            resources: {}
    status: {}

    # apply it
    thor@jumphost ~$ k apply -f deploy.yaml 
    # deployment.apps/grafana-deployment-devops created
    ```

2. Expose the deployment using NodePort service ([final file](../configs/058-svc.yaml))

    ```bash
    # dry run to generate manifest, output to svc.yaml
        thor@jumphost ~$ k expose deployment grafana-deployment-devops \
    --name=grafana-service-devops \
    --type=NodePort \
    --port=3000 \
    --target-port=3000 \
    --dry-run=client -o yaml > svc.yaml

    # print it to terminal so you can verify it has all you need
    thor@jumphost ~$ cat svc.yaml 
    apiVersion: v1
    kind: Service
    metadata:
      creationTimestamp: null
      labels:
        app: grafana-deployment-devops
      name: grafana-service-devops
    spec:
      ports:
      - port: 3000
        protocol: TCP
        targetPort: 3000
      selector:
        app: grafana-deployment-devops
      type: NodePort
    status:
      loadBalancer: {}

    # because we also need to define the nodeport requested in the config, we will modify it
    thor@jumphost ~$ vi svc.yaml 

    # printing it out once again because I added nodePort
    thor@jumphost ~$ cat svc.yaml 
    apiVersion: v1
    kind: Service
    metadata:
      creationTimestamp: null
      labels:
        app: grafana-deployment-devops
      name: grafana-service-devops
    spec:
      ports:
      - port: 3000
        protocol: TCP
        targetPort: 3000
        nodePort: 32000
      selector:
        app: grafana-deployment-devops
      type: NodePort
    status:
      loadBalancer: {}

    # apply / create the service
    thor@jumphost ~$ k apply -f svc.yaml 
    # service/grafana-service-devops created
    ```


## Key Takeaways
- Avoid fighting yaml indentation and try to generate as much of the config as possible imperatively, then modify it to meet your needs
