# Day 059: Troubleshoot Deployment issues in Kubernetes

**Time**: 5 minutes

## Objective
Last week, the Nautilus DevOps team deployed a redis app on Kubernetes cluster, which was working fine so far. This morning one of the team members was making some changes in this existing setup, but he made some mistakes and the app went down. We need to fix this as soon as possible. Please take a look.

The deployment name is `redis-deployment`. The pods are not in running state right now, so please look into the issue and fix it.

## Technologies Used
- `kubectl`
- `vi`

## Steps

1. Gather details about the pods and deployment as it stands now

    ```bash
    # First, lets check out the deployments
    thor@jumphost ~$ k get deployments.apps 
    NAME               READY   UP-TO-DATE   AVAILABLE   AGE
    redis-deployment   0/1     1            0           82s

    # Looks like the deployment has zero pods deployed to it now, there is an issue somewhere. Lets try looking at pods
    thor@jumphost ~$ k get pods
    NAME                                READY   STATUS              RESTARTS   AGE
    redis-deployment-54cdf4f76d-dshzw   0/1     ContainerCreating   0          84s

    # Okay, lets now look at the pod spec
    thor@jumphost ~$ k get deployments.apps redis-deployment -o yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
    annotations:

    creationTimestamp: "2026-01-27T11:31:51Z"
    generation: 1
    labels:
        app: redis
    name: redis-deployment
    namespace: default
    resourceVersion: "1109"
    uid: 19b25042-7e48-43aa-97ec-61fbd356c2dc
    spec:
    progressDeadlineSeconds: 600
    replicas: 1
    revisionHistoryLimit: 10
    selector:
        matchLabels:
        app: redis
    strategy:
        rollingUpdate:
        maxSurge: 25%
        maxUnavailable: 25%
        type: RollingUpdate
    template:
        metadata:
        creationTimestamp: null
        labels:
            app: redis
        spec:
        containers:
        - image: redis:alpin
            imagePullPolicy: IfNotPresent
            name: redis-container
            ports:
            - containerPort: 6379
            protocol: TCP
            resources:
            requests:
                cpu: 300m
            terminationMessagePath: /dev/termination-log
            terminationMessagePolicy: File
            volumeMounts:
            - mountPath: /redis-master-data
            name: data
            - mountPath: /redis-master
            name: config
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        schedulerName: default-scheduler
        securityContext: {}
        terminationGracePeriodSeconds: 30
        volumes:
        - emptyDir: {}
            name: data
        - configMap:
            defaultMode: 420
            name: redis-conig
            name: config
    status:
    conditions:
    - lastTransitionTime: "2026-01-27T11:31:51Z"
        lastUpdateTime: "2026-01-27T11:31:51Z"
        message: Deployment does not have minimum availability.
        reason: MinimumReplicasUnavailable
        status: "False"
        type: Available
    - lastTransitionTime: "2026-01-27T11:31:51Z"
        lastUpdateTime: "2026-01-27T11:31:51Z"
        message: ReplicaSet "redis-deployment-54cdf4f76d" is progressing.
        reason: ReplicaSetUpdated
        status: "True"
        type: Progressing
    observedGeneration: 1
    replicas: 1
    unavailableReplicas: 1
    updatedReplicas: 1

    # I see typos on the image name and config-map. Lets try to fix those next

    ```

2. Create a "fixed" manifest, and apply it. You can view the corrected manifest [here](../configs/059-deployment.yaml)

    ```bash
    # Create a new deployment yaml, based off of the existing one. 
    # You can either copy the output from the previous command and make a new file, or you could've also took the approach of kubectl edit deployment <deployment>
    thor@jumphost ~$ vi deployment.yaml

    # I am going to cat it out so you can see what I ended up with. 
    # You can also look at the file in config/059-deployment.yaml
    thor@jumphost ~$ cat deployment.yaml 
    apiVersion: apps/v1
    kind: Deployment
    metadata:
    labels:
        app: redis
    name: redis-deployment
    namespace: default
    spec:
    replicas: 1
    selector:
        matchLabels:
        app: redis
    strategy:
        rollingUpdate:
        maxSurge: 25%
        maxUnavailable: 25%
        type: RollingUpdate
    template:
        metadata:
        labels:
            app: redis
        spec:
        containers:
        - image: redis:alpine
            imagePullPolicy: IfNotPresent
            name: redis-container
            ports:
            - containerPort: 6379
            protocol: TCP
            resources:
            requests:
                cpu: 300m
            volumeMounts:
            - mountPath: /redis-master-data
            name: data
            - mountPath: /redis-master
            name: config
        volumes:
        - emptyDir: {}
            name: data
        - configMap:
            defaultMode: 420
            name: redis-config
            name: config

    # Now apply the deployment.yaml
    thor@jumphost ~$ k apply -f deployment.yaml 
    deployment.apps/redis-deployment configured
    ```

3. Verify everything is up and running

    ```bash
    # Verify everything comes up okay and the pods are running
    thor@jumphost ~$ k get pods
    NAME                                READY   STATUS        RESTARTS   AGE
    redis-deployment-54cdf4f76d-dshzw   0/1     Terminating   0          5m54s
    redis-deployment-7c8d4f6ddf-lvd9h   1/1     Running       0          21s

    # Make sure all pods needed for the deployment have deployed
    thor@jumphost ~$ k get deployments.apps 
    NAME               READY   UP-TO-DATE   AVAILABLE   AGE
    redis-deployment   1/1     1            1           5m57s
    
    ```

## Key Takeaways
- Look at the manifests first before getting too in the weeds in logs. Most of the times there's just a typo somewhere
