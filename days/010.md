# Day 010: Linux Bash Scripts

**Time**: 37 minutes

## Objective
The production support team of `xFusionCorp Industries` is working on developing some bash scripts to automate different day to day tasks. One is to create a bash script for taking websites backup. They have a static website running on `App Server 3` in `Stratos Datacenter`, and they need to create a bash script named `news_backup.sh` which should accomplish the following tasks. (Also remember to place the script under `/scripts` directory on `App Server 3`).
- Create a zip archive named `xfusioncorp_news.zip` of `/var/www/html/news` directory.
- Save the archive in `/backup/` on `App Server 3`. This is a temporary storage, as backups from this location will be clean on weekly basis. Therefore, we also need to save this backup archive on `Nautilus Backup Server`.
- Copy the created archive to `Nautilus Backup Server` server in `/backup/` location.
- Please make sure script won't ask for password while copying the archive file. Additionally, the respective server user (for example, `tony` in case of `App Server 1`) must be able to run it.
- Do not use sudo inside the script.

## Technologies Used
- `mkdir`
- `chown`
- `ls -la`
- Bash scripting
- `ssh-keygen`
- `scp`

## Steps

0. I'm adding a *Step 0* here because this prompt is wild, and is terribly worded. Putting the steps in plain language:

    I need a script `/scripts/news_backup.sh` on `stapp03` that:
    - Zips `/var/www/html/news` into `/backup/xfusioncorp_news.zip`
    - Copies that zip to `/backup/xfusioncorp_news.zip` on `stbkp01`
    - Runs as the app user (`banner`) without needing `sudo`
    - Copies over SSH without prompting for a password
    - Does not call `sudo` inside the script

1. SSH into `stapp03` server, prep directories

    ```bash
    # SSH
    thor@jumphost ~$ ssh banner@stapp03
    [banner@stapp03 ~]$

    # On App Server 3, ensure /scripts exists and is writable by the app user:
	#	mkdir /scripts
	#	chown the folder to double-tap
    [banner@stapp03 ~]$ mkdir -p /scripts
    [banner@stapp03 ~]$ sudo chown banner:banner /scripts/


	# Do the exact same thing for /backup 
	#	mkdir -p /backup
	#	chown banner:banner /backup
    [banner@stapp03 ~]$ ls -la /backup/
    total 8
    drwxrwxrwx 2 root root 4096 Dec  2 09:16 .
    drwxr-xr-x 1 root root 4096 Dec  2 09:33 ..
    [banner@stapp03 ~]$ sudo chown banner:banner /backup/

	# Make sure banner can at least read /var/www/html/media:
    [banner@stapp03 ~]$ ls -la /var/www/html/
    total 16
    drwxr-xr-x 1 root root 4096 Dec  2 09:16 .
    drwxr-xr-x 1 root root 4096 Aug 30 13:49 ..
    drwxr-xr-x 2 root root 4096 Dec  2 09:03 news
    ```

2. Install zip and set up bash script

    ```bash
    # Install zip
    [banner@stapp03 ~]$ sudo yum install zip -y

    # Create the bash script
    [banner@stapp03 ~]$ vi /scripts/news_backup.sh

    # Show you what the script looks like
    [banner@stapp03 ~]$ cat /scripts/news_backup.sh 
    #!/bin/bash
    zip -r /backup/xfusioncorp_news.zip /var/www/html/news
    scp /backup/xfusioncorp_news.zip clint@stbkp01:/backup/
    ```

3. Set up passwordless SSH

    ```bash
    # Generate key pair
    [banner@stapp03 ~]$ ssh-keygen

    # copy them over to stbkp01
    [banner@stapp03 ~]$ ssh-copy-id clint@stbkp01
    ```

4. Try out the script to see if it works

    ```bash
    # Make script executable
    [banner@stapp03 ~]$ chmod +x /scripts/news_backup.sh

    # Change directories
    [banner@stapp03 ~]$ cd /scripts

    # Execute script
    [banner@stapp03 scripts]$ ./news_backup.sh 
    adding: var/www/html/news/ (stored 0%)
    adding: var/www/html/news/.gitkeep (stored 0%)
    adding: var/www/html/news/index.html (stored 0%)
    xfusioncorp_news.zip
    ```

5. In a separate tab, log into backup server (`stbkp01), make sure it worked

    ```bash
    # SSH
    thor@jumphost ~$ ssh clint@stbkp01

    # Check directory for contents
    [clint@stbkp01 ~]$ ls -la /backup/
    total 12
    drwxrwxrwx 2 root  root  4096 Dec  2 09:49 .
    drwxr-xr-x 1 root  root  4096 Dec  2 09:51 ..
    -rw-r--r-- 1 clint clint  588 Dec  2 09:49 xfusioncorp_news.zip
    ```

## Key Takeaways
- Big, ambiguous tasks must be broken up into smaller tasks. Think of all of the tools that will need to be involved.
- Don't be frustrated if it takes a while to knock these out, still got ten days of work done in two days, you're doing fine!
