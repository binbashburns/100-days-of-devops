# Day 034: Git Hook

**Time**: 30 minutes

## Objective
The Nautilus application development team was working on a git repository `/opt/beta.git` which is cloned under `/usr/src/kodekloudrepos` directory present on `Storage server` in `Stratos DC`. The team want to setup a hook on this repository, please find below more details:

Merge the feature branch into the `master` branch, but before pushing your changes complete below point.

Create a `post-update` hook in this git repository so that whenever any changes are pushed to the `master` branch, it creates a release tag with name `release-2023-06-15`, where `2023-06-15` is supposed to be the current date. For example if today is `20th June, 2023` then the release tag must be `release-2023-06-20`. Make sure you test the hook at least once and create a release tag for today's release.

Finally remember to push your changes.
Note: Perform this task using the `natasha` user, and ensure the repository or existing directory permissions are not altered.

## Technologies Used
- `git`
- `bash`
- `ssh`

## Steps

1. SSH into the Storage server as `natasha`

    ```bash
    # Connect to the storage server
    thor@jumphost ~$ ssh natasha@ststor01
    ```

2. Verify repository locations and permissions

    ```bash
    # Confirm the bare repository and working clone exist
    [natasha@ststor01 ~]$ ls -ld /opt/beta.git /usr/src/kodekloudrepos

    # Verify the cloned working directory exists
    [natasha@ststor01 ~]$ ls -ld /usr/src/kodekloudrepos/beta
    ```

3. Inspect the current Git state of the working repository

    ```bash
    # Move into the cloned repository
    [natasha@ststor01 ~]$ cd /usr/src/kodekloudrepos/beta

    # Check the current branch and working tree status
    [natasha@ststor01 beta]$ git status

    # Fetch all remote branches
    [natasha@ststor01 beta]$ git fetch --all --prune

    # List all branches
    [natasha@ststor01 beta]$ git branch -a
    ```

4. Switch to `master` and merge the feature branch

    ```bash
    # Switch to the master branch
    [natasha@ststor01 beta]$ git checkout master

    # Ensure master is fully up to date
    [natasha@ststor01 beta]$ git pull --ff-only origin master

    # Merge the feature branch into master
    [natasha@ststor01 beta]$ git merge origin/feature

    # Confirm merge status
    [natasha@ststor01 beta]$ git status
    ```

5. Create the `post-update` hook on the bare repository

    ```bash
    # Move to the hooks directory of the bare repository
    [natasha@ststor01 beta]$ cd /opt/beta.git/hooks

    # Create the post-update hook
    [natasha@ststor01 hooks]$ cat > post-update <<'EOF'
    #!/usr/bin/env bash
    set -euo pipefail

    # Only act when master is one of the updated refs
    master_updated="false"
    for ref in "$@"; do
    if [[ "$ref" == "refs/heads/master" ]]; then
        master_updated="true"
        break
    fi
    done

    # Exit quietly if master was not updated
    if [[ "$master_updated" != "true" ]]; then
    exit 0
    fi

    # Generate today's date in UTC
    today="$(date -u +%F)"
    tag="release-${today}"

    # Resolve the new commit SHA for master
    master_sha="$(git rev-parse refs/heads/master)"

    # If the tag already exists and points to the same commit, do nothing
    if git show-ref --verify --quiet "refs/tags/${tag}"; then
    current_sha="$(git rev-parse "refs/tags/${tag}")"
    if [[ "$current_sha" == "$master_sha" ]]; then
        exit 0
    fi
    fi

    # Create or update the release tag
    git tag -f "${tag}" "${master_sha}"

    # Log hook activity
    echo "Created/updated ${tag} -> ${master_sha}" >&2
    EOF

    # Make the hook executable
    [natasha@ststor01 hooks]$ chmod +x post-update
    ```

6. Push the merged `master` branch and trigger the hook

    ```bash
    # Return to the working repository
    [natasha@ststor01 hooks]$ cd /usr/src/kodekloudrepos/beta

    # Push master to trigger the post-update hook
    [natasha@ststor01 beta]$ git push origin master
    ```

7. Verify the release tag was created

    ```bash
    # Fetch tags from the remote
    [natasha@ststor01 beta]$ git fetch --tags

    # List release tags
    [natasha@ststor01 beta]$ git tag -l "release-*"

    # Inspect the release tag
    [natasha@ststor01 beta]$ git show "release-$(date -u +%F)" --no-patch --decorate
    ```

## Key Takeaways
- For this one, I struggled quite a bit and had to look at other examples of what people had done. Submission was buggy, and not straightforward. 
- At some point had to ask AI for help on ensuring I checked proper permissions on files, and building out the tagging hook verbiage
